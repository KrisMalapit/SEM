@model SEMSystem.Models.EmergencyLightHeader


<style>
    /*table input {
        border-color: #e9ecef;
    }*/
</style>
<div class="col-lg-12">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <h2>Emergency Light</h2>
            <div class="row">
                <label class="col-md-2 col-form-label" style="padding-top:5px;"> Area</label>


              
                    <div class="col-md-4">

                        @*  <select id="AreaId" name="AreaId" class="form-control" asp-items="@ViewBag.AreaId" disabled></select>*@
                        <input id="AreaId" name="AreaId" class="form-control" disabled value="@ViewBag.Area" />

                    </div>

           


                <label class="col-md-2 col-form-label" style="padding-top:5px;"> Date</label>
                <div class="col-md-4">
                    <input id="Date" name="Date" class="form-control" disabled value="@ViewBag.CreatedAt" />
                </div>
            </div>
            <br />
            <div class="row">
                <label class="col-md-2 col-form-label" style="padding-top:5px;"> Location</label>
                <div class="col-md-4">


                    @*<select id="LocationId" name="LocationId" class="form-control" asp-items="ViewBag.LocationId" disabled></select>*@
                    <input id="LocationId" name="LocationId" class="form-control" disabled value="@ViewBag.Location" />

                </div>
                <label class="col-md-2 col-form-label" style="padding-top:5px;"> Plant</label>
                <div class="col-md-4">
                    <input id="Plant" name="Plant" class="form-control" disabled value="@ViewBag.Company" />

                </div>
            </div>
            <br />

            <table id="tbl" class="table table-striped table-no-bordered table-hover dataTable" style="width: 100%!important">

                <thead>
                    <tr>
                        <th>ID</th>
                        <th width="20%">Item</th>
                        <th width="15%">Code</th>

                        <th>Battery</th>
                        <th>Bulb</th>
                        <th>Usable</th>

                        <th width="25%">Remarks</th>

                    </tr>

                </thead>

            </table>
            <p>

                <a href="#" onclick="saveEmergencyData();">
                    <i class="fa fa-check"></i>
                    <span class="email-text">&nbsp;Save</span>
                </a> 
                
                <text> |&nbsp; </text>




                <a href="#" onclick="print('@ViewBag.ID','rptEmergencyLight');">
                    <i class="fa fa-print"></i>
                    <span class="print">&nbsp;Print</span>
                </a>





            </p>
            <a asp-action="Index">Back to List</a>
        </div>
           
        </div>
</div>


<script>
        $(function () {
           
            if ( @ViewBag.ID == 0) {
                loadDatatable($("#AreaId").val());
                
            } else {
                loadDatatableEdit();
               
            }
            


        })
        $("#AreaId").change(function () {
            $("#Plant").val("");
             loadDatatable(this.value);
        })
        $("input[type=text]").keyup(function () {
            $(this).val($(this).val().toUpperCase());
        });
        function loadDatatable(_area) {

        var data = [];

         $.ajax({
                        url: "@Url.Action("getDataPerArea")"
                            , method: "POST"
                            , dataType: 'json'
                            , data: { AreaId: _area }
                            , success: function (responsedata) {

                                if (responsedata.status == "success" && responsedata.data.length > 0) {

                                    //$("#Plant").val(responsedata.data[0].companyName);

                                    for (var i = 0; i < responsedata.data.length; i++) {

                                        var $id = responsedata.data[i].id;



                                        var _remarks = "<input class='form-control' style='width:100%' onfocus='this.select();'  value='' data-id='" + $id + "'>";



                                        var _battery = '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type="checkbox" value="" name="Battery" >' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                        var _bulb = '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type="checkbox" value="" name="Bulb" >' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                        var _usable = '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type="checkbox" value="" name="Usable" >' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                       

                                        data.push([
                                            responsedata.data[i].itemId
                                            , responsedata.data[i].itemName
                                            , responsedata.data[i].code
                                           
                                            , _battery
                                            , _bulb
                                            , _usable
                                          
                                            , _remarks
                                           ]);

                                    }
                                    if ($.fn.DataTable.isDataTable('#tbl')) {
                                        $('#tbl').DataTable().destroy();
                                    }
                                    $('#tbl').DataTable({
                                        "data": data,
                                        "responsive": true,
                                        "lengthMenu": [[50, 100, -1], [50, 100, "All"]],
                                        //"columnDefs": [
                                        //    {
                                        //        visible: false,
                                        //        targets: [0]
                                        //    },
                                        //],
                                    });
                                } else {
                                    if (responsedata.data.length < 1) {



                                        if ($.fn.DataTable.isDataTable('#tbl')) {
                                            $('#tbl').DataTable().destroy();
                                        }
                                        $('#tbl').DataTable({
                                            "data": data,
                                            "responsive": true,
                                            "lengthMenu": [[50, 100, -1], [50, 100, "All"]],
                                            //"columnDefs": [
                                            //    {
                                            //        visible: false,
                                            //        targets: [0]
                                            //    },
                                            //],
                                        });

                                    }

                                }

                            }
            });






        }
        function loadDatatableEdit() {

        var data = [];

         $.ajax({
                        url: "@Url.Action("getDataDetails")"
                            , method: "POST"
                            , dataType: 'json'
                            , data: { id: @ViewBag.ID }
                            , success: function (responsedata) {

                                if (responsedata.status == "success") {
                                   
                                    //$("#Plant").val(responsedata.data[0].companyName);
                                    for (var i = 0; i < responsedata.data.length; i++) {
                                        var $id = responsedata.data[i].id;
                                        
                                        $checkedValue = "";

                                        if (responsedata.data[i].battery == 1) {
                                            $checkedValue = 'checked';
                                        } 
                                      
                                        var _battery =
                                            '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type = "checkbox" value = "" name = "Battery" ' + $checkedValue + '>' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                        $checkedValue = "";
                                        if (responsedata.data[i].bulb == 1) {
                                            $checkedValue = 'checked';
                                        }

                                        var _bulb = '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type="checkbox" value="" name="Bulb" ' + $checkedValue + '>' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                        $checkedValue = "";
                                        if (responsedata.data[i].usable == 1) {
                                            $checkedValue = 'checked';
                                        }

                                        var _usable = '<div class="form-check">' +
                                            '<label class="form-check-label">' +
                                            '<input class="form-check-input" type="checkbox" value="" name="Usable" ' + $checkedValue + '>' +
                                            '<span class="form-check-sign"><span class="check"></span></span>' +
                                            '</label>' +
                                            '</div>';

                                      

                                        //var _remarks = "<input class='form-control' style='width:100%' onfocus='this.select();' value='" + responsedata.data[i].remarks + "'>";
                                        var _rem = responsedata.data[i].remarks === null ? "" : responsedata.data[i].remarks;
                                        var _remarks = "<input class='form-control' style='width:100%' onfocus='this.select();' value='" + _rem + "'>";
                                        data.push([
                                            responsedata.data[i].itemId
                                            , responsedata.data[i].itemName
                                            , responsedata.data[i].code

                                            , _battery
                                            , _bulb
                                            , _usable
                                           
                                            , _remarks
                                           ]);

                                    }
                                    if ($.fn.DataTable.isDataTable('#tbl')) {
                                        $('#tbl').DataTable().destroy();
                                    }
                                    $('#tbl').DataTable({
                                        "data": data,
                                        "responsive": true,
                                        "lengthMenu": [[50, 100, -1], [50, 100, "All"]],
                                        //"columnDefs": [
                                        //    {
                                        //        visible: false,
                                        //        targets: [0]
                                        //    },
                                        //],
                                    });
                                } else {
                                    


                                        if ($.fn.DataTable.isDataTable('#tbl')) {
                                            $('#tbl').DataTable().destroy();
                                        }
                                        $('#tbl').DataTable({
                                            "data": data,
                                            "responsive": true,
                                            "lengthMenu": [[50, 100, -1], [50, 100, "All"]],
                                            //"columnDefs": [
                                            //    {
                                            //        visible: false,
                                            //        targets: [0]
                                            //    },
                                            //],
                                        });

                                   

                                }

                            }
            });






        }
        function saveEmergencyData () {


            var items = [];
            $("#tbl tbody tr").each(function () {
                //console.log($(this).closest('tr').find('input:checkbox')[0].checked)

                     var obj = {
                         ItemId: $(this).find("td:eq(0)").text(),
                         Battery: $(this).find('input:checkbox')[0].checked,
                         Bulb: $(this).find('input:checkbox')[1].checked,
                         Usable: $(this).find('input:checkbox')[2].checked,
                        
                         Remarks: $(this).find("td:eq(6)").find("input").val(),
                         AreaId: $("#AreaId").val(),
                         ID: @ViewBag.ID

                    }
                    items.push(obj)


                });


            console.log(items);

            $.ajax({
                url: "@Url.Action("EditData")"
                , type: "POST"
                , dataType: "json"
                , data: { item: items }
                     , success: function (responsedata) {

                        if (responsedata.status == "success") {

                            toastr["success"]("Item saved!", "<b>Success</b> ")


                        } else {

                            toastr["error"](responsedata.message)
                            toastr.options = {
                                "closeButton": true,
                                "showDuration": "3000",
                            }
                        }
                    }
                })


    }
    function print($refid,$rpt) {
        window.open('@Url.Action("printReport", "Reports")?ReferenceId=' + $refid+ '&Report=' + $rpt + '&rptType=PDF');
    }


</script>
